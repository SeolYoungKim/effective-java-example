# 자바 직렬화의 대안을 찾으라 
## 직렬화의 문제점 
- 공격 범위가 너무 넓고, 지속적으로 더 넓어져 방어하기 어려움 
  - `ObjectInputStream`의 `readObject` 메서드를 호출하면서 객체 그래프가 역직렬화되기 때문 
  - `readObject` 메서드는 `Serializable` 인터페이스를 구현했다면 클래스패스 안의 거의 모든 타입의 객체를 만들어낼 수 있다.
  - 바이트 스트림을 역직렬화하는 과정에서 해당 메서드는 그 타입들 안의 모든 코드를 수행할 수 있음 
  - 즉, **그 타입들의 코드 전체가 공격 범위에 들어간다는 뜻임**


- 모든 직렬화 가능 클래스들을 공격에 대비하도록 작성한다 해도, 우리의 애플리케이션은 여전히 취약할 수 있음 


## 자바의 역직렬화는 명백하고 현존하는 위험이다.
- 애플리케이션에서 직접 사용되거나 
- 자바 하부 시스템을 통해 간접적으로 사용되고 있기 때문 
  - RMI: Remote Method Invocation
  - JMX: Java Management Extension
  - JMS: Java Messaging System 
- 신뢰할 수 없는 스트림을 역직렬화 할 경우, 원격 코드 실행(remote code execution, RCE), 서비스 거부(denial-of-service, DoS) 등의 공격으로 이어질 수 있음 
  - 잘못한 게 아무것도 없는 애플리케이션임에도 불구하고, 이런 공격에 취약해질 가능성이 존재함 


## 가젯(gadget)
- 직렬화 가능 타입들 중에서, 역직렬화 과정에서 호출되어 잠재적으로 위험한 동작을 수행하는 메서드 
- 여러 가젯들을 함께 사용하여 가젯 체인을 구성할 수도 있음 
  - 가끔씩 공격자가 기반 하드웨어의 네이티브 코드를 마음대로 실행할 수 있는 아주 강력한 가젯 체인도 발견되곤 함 
  - 신중하게 제작한 바이트 스트림만 역직렬화 해야 함 


## 역직렬화에 시간이 오래 걸리는 짧은 스트림
- 역직렬화에 시간이 오래 걸리는 짧은 스트림을 역직렬화하는 것만으로도 서비스 거부 공격에 쉽게 노출될 수 있음 
  - 이런 스트림을 역직렬화 폭탄(deserialization bomb)이라고 함 
  - `HashSet` 인스턴스는 역직렬화 하려면 그 원소들의 해시코드를 계산해야 함 (시간이 오래 걸림) 
- 역직렬화가 영원히 계속된다는 것도 문제이나, 무언가 잘못되었다는 신호조차 주지 않음


## 문제 대처 
- 애초에 신뢰할 수 없는 바이트 스트림을 역직렬화 하는 것 자체가 스스로를 공격에 노출하는 행위임 
- **직렬화 위험을 회피하는 가장 좋은 방법은 아무것도 역직렬화하지 않는 것이다.**
  - 우리가 작성하는 새로운 시스템에서 자바 직렬화를 사용해야 할 이유는 전혀 없다. 
  - 객체와 바이트 시퀀스를 변환 해주는 다른 메커니즘이 많이 있다. 그걸 쓰자. 
    - 자바 직렬화의 여러 위험 회피, 다양한 플랫폼 지원, 우수한 성능, ... 


## 크로스-플랫폼 구조화된 데이터 표현(cross-platform structured-data representation)
- 자바 직렬화보다 훨씬 간단함 
- 임의 객체 그래프를 자동으로 직렬화/역직렬화하지 않음
- 속성-값 쌍의 집합으로 구성된 간단하고 구조화된 데이터 객체를 사용함 
- 기본 타입 몇 개와 배열 타입만 지원 


### JSON
- 더글라스 크록퍼드가 브라우저와 서버의 통신용으로 설계함
- 텍스트 기반, 사람이 읽기 편함  
- 오직 데이터 표현에만 쓰임 

### 프로토콜 버퍼(Protocol Buffers, protobuf)
- 구글이 서버 사이에 데이터를 교환하고 저장하기 위해 설계함 
- 이진 표현, 효율이 높음 
  - pbtxt라는 사람이 읽을 수 있는 텍스트 표현도 지원함 
- 문서를 위한 스키마(타입)를 제공하고 올바로 쓰도록 강요 

## 레거시 
- **신뢰할 수 없는 데이터는 절대 역직렬화하지 말자**
- 신뢰할 수 없는 발신원으로부터의 RMI(Remote Method Invocation)는 절대 수용해서는 안된다.
- 하지만 직렬화를 피할 수 없다면 
  - 역직렬화 필터링(`ObjectInputFilter`)를 사용하자. 
  - 데이터 스트림이 역직렬화되기 전에 필터를 설치하는 기능 
  - 클래스 단위로 특정 클래스를 받아들이거나 거부할 수 있음 
  - 기본 수용 모드에서는 블랙리스트에 기록된 잠재적으로 위험한 클래스들을 거부함 
  - 기본 거부 모드에서는 화이트리스트에 기록된 클래스만 수용함 -> 추천
    - SWAT(Serial Whitelist Application Trainer)이라는 도구가 있으니 참고할 것 
  
## 정리
- 자바 직렬화는 위험하니 피하자
- JSON, Protocol Buffer와 같은 대안을 사용하자
- 신뢰할 수 없는 데이터는 역직렬화하지 말자
- 꼭 해야한다면, 객체 역직렬화 필터링을 사용하되, 이마저도 모든 공격을 막아줄 수는 없음을 기억하자
- 클래스가 직렬화를 지원하도록 만들지 말고, 꼭 그렇게 만들어야 한다면 정말 신경써서 작성해야 한다 